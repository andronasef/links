<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GitHub Issues List - andronasef/links</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f8fa;
      }
      h1 {
        color: #2d333b;
        border-bottom: 2px solid #e1e4e8;
        padding-bottom: 0.5em;
        margin-bottom: 1em;
      }
      .search-container {
        margin: 20px 0;
        position: relative;
      }
      #searchInput {
        box-sizing: border-box;
        width: 100%;
        padding: 12px 0px 12px 15px; /* Adjust padding to make space for the icon */
        border: 1px solid #d0d7de;
        border-radius: 6px;
        font-size: 16px;
        transition: all 0.2s ease;
      }
      .search-icon {
        position: absolute;
        right: 15px; /* Adjust the position of the icon */
        top: 50%;
        transform: translateY(-50%); /* Center the icon vertically */
        color: #6a737d; /* Icon color */
        pointer-events: none; /* Ensure the icon doesn't interfere with input clicks */
      }
      .issue-item {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin: 10px 0;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        gap: 10px;
      }
      .issue-header {
        display: flex;
        align-items: center;
        width: 100%;
        gap: 15px;
      }
      .issue-comment {
        margin-left: 0;
        margin-top: 8px;
        padding: 10px;
        background: #f6f8fa;
        border-radius: 6px;
        border-left: 3px solid #0969da;
        font-size: 13px;
        color: #24292f;
        width: 100%;
        box-sizing: border-box;
      }
      .button-group {
        display: flex;
        gap: 10px;
        flex-shrink: 0;
      }
      .issue-title {
        flex: 1;
        color: #0969da;
        text-decoration: none;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        font-size: 14px;
      }
      .copy-btn,
      .original-btn {
        flex-shrink: 0;
        padding: 8px 12px;
        background: #f6f8fa;
        color: #24292f;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
      }
      .copy-btn:hover,
      .original-btn:hover {
        background: #0969da;
        color: white;
        border-color: #0969da;
      }
      .original-btn {
        background: #f0f8ff;
        border-color: #0969da;
        color: #0969da;
      }
      .original-btn:hover {
        background: #0969da;
        color: white;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #24292f;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        display: none;
        animation: fadeInOut 2.5s;
      }
      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0;
        }
        10%,
        90% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <h1>
      <i class="fab fa-github"></i>
      Issues for andronasef/links
    </h1>

    <div class="search-container">
      <input
        type="text"
        id="searchInput"
        placeholder="Search issues by title..."
      />
      <i class="fas fa-search search-icon"></i>
      <!-- Moved inside the container -->
    </div>

    <div id="issues-list"></div>
    <div class="toast" id="toast">Link copied to clipboard!</div>

    <script>
      let allIssues = [];
      let issuesWithComments = [];

      async function fetchIssues() {
        try {
          const response = await fetch(
            "https://api.github.com/repos/andronasef/links/issues"
          );
          allIssues = await response.json();

          // Fetch comments for all issues
          issuesWithComments = await Promise.all(
            allIssues.map(async (issue) => {
              try {
                const commentsResponse = await fetch(
                  `https://api.github.com/repos/andronasef/links/issues/${issue.number}/comments`
                );
                const comments = await commentsResponse.json();
                return {
                  ...issue,
                  comments: comments,
                };
              } catch (error) {
                console.error(
                  "Error fetching comments for issue",
                  issue.number,
                  ":",
                  error
                );
                return {
                  ...issue,
                  comments: [],
                };
              }
            })
          );

          renderIssues(issuesWithComments);
        } catch (error) {
          console.error("Error fetching issues:", error);
          document.getElementById("issues-list").innerHTML =
            "<p>⚠️ Error loading issues. Please try again later.</p>";
        }
      }

      function renderIssues(issues) {
        const listContainer = document.getElementById("issues-list");
        listContainer.innerHTML = "";

        if (issues.length === 0) {
          listContainer.innerHTML =
            '<div class="no-results">No matching issues found</div>';
          return;
        }

        issues.forEach((issue) => {
          const issueElement = document.createElement("div");
          issueElement.className = "issue-item";

          // Display first comment if available (above the title)
          if (issue.comments && issue.comments.length > 0) {
            const firstComment = issue.comments[0];
            const commentElement = document.createElement("div");
            commentElement.className = "issue-comment";

            // Extract text content from comment body (remove markdown if needed)
            const commentText =
              firstComment.body.length > 200
                ? firstComment.body.substring(0, 200) + "..."
                : firstComment.body;

            commentElement.textContent = commentText;
            issueElement.appendChild(commentElement);
          }

          const issueHeader = document.createElement("div");
          issueHeader.className = "issue-header";

          const titleLink = document.createElement("a");
          titleLink.className = "issue-title";
          titleLink.href = issue.html_url;
          titleLink.target = "_blank";
          titleLink.textContent = `#${issue.number} - ${issue.title}`;

          const buttonGroup = document.createElement("div");
          buttonGroup.className = "button-group";

          const originalButton = document.createElement("button");
          originalButton.className = "original-btn";
          originalButton.innerHTML =
            '<i class="fas fa-external-link-alt"></i> Open';
          originalButton.onclick = () => {
            const shortLink = `https://andronasef.github.io/links/${issue.number}`;
            window.open(shortLink, "_blank");
          };

          const copyButton = document.createElement("button");
          copyButton.className = "copy-btn";
          copyButton.innerHTML = '<i class="far fa-copy"></i> Copy';
          copyButton.onclick = () => {
            const shortLink = `https://andronasef.github.io/links/${issue.number}`;
            navigator.clipboard
              .writeText(shortLink)
              .then(() => {
                const toast = document.getElementById("toast");
                toast.style.display = "block";
                setTimeout(() => (toast.style.display = "none"), 2500);
              })
              .catch((err) => console.error("Copy failed:", err));
          };

          buttonGroup.appendChild(originalButton);
          buttonGroup.appendChild(copyButton);

          issueHeader.appendChild(titleLink);
          issueHeader.appendChild(buttonGroup);
          issueElement.appendChild(issueHeader);

          listContainer.appendChild(issueElement);
        });
      }

      document.getElementById("searchInput").addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredIssues = issuesWithComments.filter((issue) => {
          // Search in issue title
          const titleMatch = issue.title.toLowerCase().includes(searchTerm);

          // Search in comments
          const commentMatch =
            issue.comments &&
            issue.comments.some((comment) =>
              comment.body.toLowerCase().includes(searchTerm)
            );

          return titleMatch || commentMatch;
        });
        renderIssues(filteredIssues);
      });

      fetchIssues();
    </script>
  </body>
</html>
